# Lost & Found Service – Проектная схема

Сервис для работы с потерянными вещами в транспорте: учёт найденных вещей, поиск, заявки на возврат, выдача/доставка.

---

## 1. Бизнес-процесс (MVP)

1. **Сотрудник** находит вещь и заносит её в систему:
   - название, описание, категория;
   - где нашли (тип транспорта, маршрут, номер ТС);
   - на какой склад отвезли;
   - фото.
2. **Пользователь** теряет вещь → заходит на сайт:
   - ищет по названию, категории, месту находки;
   - открывает карточку вещи.
3. Пользователь создаёт **заявку на возврат** на конкретную вещь:
   - пишет комментарий, почему это его вещь (описание, приметы и т.д.).
4. **Сотрудник** проверяет заявку:
   - подтверждает / отклоняет.
5. После подтверждения:
   - пользователь выбирает **самовывоз со склада** или **доставку**;
   - при самовывозе — приходит на склад, получает вещь;
   - при доставке — создаётся отправление, отслеживание статуса.
6. При выдаче/доставке:
   - заявка помечается как `COMPLETED`;
   - вещь — как `RETURNED`.

---

## 2. Роли и модель пользователей

### 2.1. Роли

- `USER` — обычный пользователь (потерял вещь, ищет, создаёт заявки).
- `EMPLOYEE` — сотрудник (заносит вещи, обрабатывает заявки).
- `ADMIN` (опционально) — управление справочниками и сотрудниками.

### 2.2. Таблица `users`

Одна общая таблица с ролью (для семестрового проекта — оптимальный вариант).

**users**

| Поле           | Тип        | Описание                          |
| -------------- | ---------- | --------------------------------- |
| `id`           | PK         | Идентификатор пользователя        |
| `first_name`   | string     | Имя                               |
| `last_name`    | string     | Фамилия                           |
| `phone`        | string     | Телефон                           |
| `email`        | string     | Почта (уникальная)                |
| `password_hash`| string     | Хэш пароля                        |
| `role`         | enum       | `USER` / `EMPLOYEE` / `ADMIN`     |
| `created_at`   | datetime   | Дата создания                     |
| `updated_at`   | datetime   | Дата обновления                   |

---

## 3. Доменные сущности (Entities)

### 3.1. Склады – `warehouses`

**Warehouse**

| Поле          | Тип      | Описание                                |
| ------------- | -------- | --------------------------------------- |
| `id`          | PK       | Идентификатор склада                    |
| `name`        | string   | Название склада                         |
| `address`     | string   | Адрес                                   |
| `working_hours` | string | Часы работы (формат свободный)         |
| `phone`       | string   | Телефон склада (опционально)           |
| `created_at`  | datetime | Дата создания                           |
| `updated_at`  | datetime | Дата обновления                         |

---

### 3.2. Категории – `categories`, `item_categories`

**Category**

| Поле        | Тип      | Описание                                |
| ----------- | -------- | --------------------------------------- |
| `id`        | PK       | Идентификатор категории                 |
| `name`      | string   | Название категории                      |
| `parent_id` | FK→categories.id, nullable | Родительская категория (для дерева) |
| `created_at`| datetime | Дата создания                           |

**ItemCategory** (связь многие-ко-многим)

| Поле        | Тип      | Описание                        |
| ----------- | -------- | ------------------------------- |
| `item_id`   | FK→lost_items.id | Вещь                   |
| `category_id` | FK→categories.id | Категория            |

---

### 3.3. Вещи – `lost_items`

**LostItem**

| Поле                      | Тип        | Описание                                                           |
| ------------------------- | ---------- | ------------------------------------------------------------------ |
| `id`                      | PK         | Идентификатор вещи                                                 |
| `title`                   | string     | Название вещи (например, «iPhone 13», «рюкзак»）                   |
| `description`             | text       | Краткое описание                                                   |
| `photo_url`               | string     | Ссылка на фото                                                     |
| `found_transport_type`    | enum/string| Тип транспорта (`BUS`, `TRAM`, `METRO`, `TRAIN`, ...)             |
| `found_route_number`      | string     | Номер маршрута                                                     |
| `found_vehicle_number`    | string     | Номер транспортного средства                                       |
| `found_at`                | datetime   | Время/дата находки                                                 |
| `current_warehouse_id`    | FK→warehouses.id | Текущий склад                                                 |
| `current_location_details`| string     | Доп. инфа («Стеллаж A, полка 3»)                                   |
| `status`                  | enum       | Статус вещи (см. ниже)                                            |
| `created_by_employee_id`  | FK→users.id| Кто завёл вещь (сотрудник)                                         |
| `created_at`              | datetime   | Дата создания записи                                               |
| `updated_at`              | datetime   | Дата обновления                                                    |

Возможные значения `status`:

- `FOUND` — только что добавлена, доступна для поиска.
- `PENDING_CONFIRMATION` — есть активная заявка, идёт проверка.
- `RESERVED` — заявка подтверждена, вещь зарезервирована за конкретным пользователем.
- `DELIVERING` — в процессе доставки.
- `RETURNED` — успешно возвращена владельцу.
- `DISPOSED` — утилизирована / невостребована (опционально, если дойдёшь до этого).

---

### 3.4. Страны доставки – `countries`

**Country**

| Поле         | Тип      | Описание                                    |
| ------------ | -------- | ------------------------------------------- |
| `id`         | PK       | Идентификатор страны                        |
| `code`       | string   | Код страны (ISO, например `CZ`, `UA`)       |
| `name`       | string   | Название страны                             |
| `is_supported` | boolean| Можно ли доставлять в эту страну            |
| `base_price` | decimal  | Базовый тариф (опционально)                 |
| `created_at` | datetime | Дата создания                               |

---

### 3.5. Заявки на возврат – `return_requests`

**ReturnRequest**

| Поле                      | Тип        | Описание                                        |
| ------------------------- | ---------- | ----------------------------------------------- |
| `id`                      | PK         | Идентификатор заявки                            |
| `user_id`                 | FK→users.id| Пользователь, подавший заявку                   |
| `item_id`                 | FK→lost_items.id | Вещь, которую пытаются вернуть           |
| `status`                  | enum       | Статус заявки (см. ниже)                        |
| `user_comment`            | text       | Описание от пользователя (доказательства)       |
| `internal_comment`        | text       | Комментарий сотрудника (опционально)            |
| `fulfillment_type`        | enum       | `PICKUP`, `DELIVERY_DOMESTIC`, `DELIVERY_INTERNATIONAL` |
| `created_at`              | datetime   | Дата создания заявки                            |
| `confirmed_at`            | datetime   | Дата подтверждения (если подтверждена)          |
| `processed_by_employee_id`| FK→users.id, nullable | Кто обработал заявку                 |

Возможные значения `status`:

- `PENDING` — ожидает проверки.
- `APPROVED` — подтверждена сотрудником.
- `REJECTED` — отклонена.
- `CANCELLED` — отменена пользователем.
- `COMPLETED` — завершена, вещь выдана/доставлена.

---

### 3.6. Отправления (доставка) – `shipments`

**Shipment**

| Поле           | Тип        | Описание                                  |
| -------------- | ---------- | ----------------------------------------- |
| `id`           | PK         | Идентификатор доставки                    |
| `request_id`   | FK→return_requests.id | Связанная заявка              |
| `type`         | enum       | `DOMESTIC` или `INTERNATIONAL`            |
| `address_line1`| string     | Адрес – строка 1                          |
| `address_line2`| string     | Адрес – строка 2 (опц.)                   |
| `city`         | string     | Город                                     |
| `postal_code`  | string     | Почтовый индекс                           |
| `country_id`   | FK→countries.id | Страна                               |
| `carrier`      | string     | Название перевозчика (`UPS`, `MockCarrier`) |
| `tracking_number` | string  | Номер отслеживания                        |
| `status`       | enum       | Статус доставки (см. ниже)                |
| `created_at`   | datetime   | Дата создания записи                      |
| `updated_at`   | datetime   | Дата обновления                           |

Возможные значения `status`:

- `CREATED` — создано, ждёт отправки.
- `IN_TRANSIT` — в пути.
- `DELIVERED` — доставлено.
- `LOST` — утеряно при доставке (опционально).
- `CANCELLED` — отменено.

---

## 4. Связи между сущностями (ER-логика)

Текстовое описание:

- `users (USER)` 1 – * `return_requests`
- `lost_items` 1 – * `return_requests` (разные люди могут попытаться забрать одну вещь)
- `lost_items` * – * `categories` через таблицу `item_categories`
- `warehouses` 1 – * `lost_items`
- `return_requests` 1 – 0..1 `shipments`
- `countries` 1 – * `shipments`
- `users (EMPLOYEE)` 1 – * `lost_items` (через `created_by_employee_id`)
- `users (EMPLOYEE)` 1 – * `return_requests` (через `processed_by_employee_id`)

Грубая ASCII-схема:

``` text
User (role=USER/EMPLOYEE)
  | 1
  | *
ReturnRequest *-----------1 LostItem
      |                        |
      | 0..1                   | *
   Shipment               ItemCategory *------1 Category
      |
      1
   Country

LostItem
  |
  1
Warehouse
```


## 5. Сервисы / модули приложения

Логическое разделение по слоям (можно реализовать как классы/модули в одном монолите).

---

### 5.1. Auth / User Service

**Назначение:**

- Регистрация и логин пользователей.
- Управление ролями (создание сотрудников/админов — через отдельный административный путь).
- Получение данных текущего пользователя (`/me`).

**Примеры операций:**

- `registerUser(...)`
- `login(email, password)`
- `getCurrentUser()`

---

### 5.2. Lost Item Management Service (для сотрудников)

**Назначение:**

Работа с найденными вещами (только для сотрудников с ролью `EMPLOYEE`/`ADMIN`).

**Функции:**

- Создать запись о найденной вещи.
- Обновить данные (склад, место, описание).
- Изменить статус вещи (например, `FOUND → DISPOSED` и т.д.).

**Примеры операций:**

- `createLostItem(dto, employeeId)`
- `updateLostItem(itemId, dto, employeeId)`
- `setItemStatus(itemId, status, employeeId)`

---

### 5.3. Search Service (для пользователей)

**Назначение:**

Поиск вещей обычными пользователями.

**Функции:**

- Поиск по названию.
- Поиск по категории.
- Фильтрация по транспорту/маршруту.
- Возвращает только вещи со статусами `FOUND` или `PENDING_CONFIRMATION` (опционально, если так решишь).

**Примеры REST-эндпоинтов:**

- `GET /items?query=phone&categoryId=1`
- `GET /items/{id}` — детальная карточка вещи.

---

### 5.4. Return Request Service

**Назначение:**

Работа с заявками на возврат.

#### Для пользователей:

- Создание новой заявки (`PENDING`).
- Просмотр своих заявок.
- Отмена заявки (`CANCELLED`), если ещё не обработана.

#### Для сотрудников:

- Просмотр всех заявок со статусом `PENDING`.
- Подтверждение (`APPROVED`) или отклонение (`REJECTED`):
  - при `APPROVED` → `lost_items.status = RESERVED`
  - при `REJECTED` → статус вещи можно оставить `FOUND`.

**Примеры операций:**

- `createReturnRequest(userId, itemId, userComment)`
- `approveRequest(requestId, employeeId, internalComment?)`
- `rejectRequest(requestId, employeeId, reason)`
- `cancelRequest(requestId, userId)`

---

### 5.5. Fulfillment / Issuance Service (выдача/доставка)

**Назначение:**

Работа со способом получения вещи после одобрения заявки.

**Функции:**

- Установка `fulfillment_type` в заявке:
  - `PICKUP`
  - `DELIVERY_DOMESTIC`
  - `DELIVERY_INTERNATIONAL`

#### Для `PICKUP`:

- Показать пользователю адрес склада, часы работы.
- После фактической выдачи:
  - `ReturnRequest.status = COMPLETED`
  - `LostItem.status = RETURNED`.

#### Для `DELIVERY_*`:

- Создание `Shipment` + генерация `tracking_number`.
- Изменение статуса `Shipment`:
  - `CREATED → IN_TRANSIT → DELIVERED`.
- При `DELIVERED`:
  - `ReturnRequest.status = COMPLETED`
  - `LostItem.status = RETURNED`.

---

### 5.6. Shipment / External Carrier Integration (опционально)

**Назначение:**

Интеграция с внешним «перевозчиком» (можно сделать фиктивный сервис).

**Функции:**

- `createShipment(requestId, address, carrier)`:
  - создаёт запись в `shipments`;
  - генерирует рандомный `tracking_number`.
- `updateShipmentStatus(shipmentId, newStatus)`:
  - меняет статус в БД;
  - по cron/ручной кнопке можно симулировать движение посылки.

---

### 5.7. Admin Service (опционально)

**Назначение:**

Административный функционал.

**Функции:**

CRUD для:

- `warehouses`
- `categories`
- `countries`

А также (если захочешь):

- Управление пользователями/ролями.

---

## 6. Минимальный план работы (черновик под TODO)

Чтобы дальше расписывать детальный план, можно использовать такой скелет.

---

### 6.1. Доменная модель и БД

- [ ] Описать все таблицы:
  - `users`
  - `warehouses`
  - `categories`
  - `lost_items`
  - `item_categories`
  - `return_requests`
  - `countries`
  - `shipments`
- [ ] Написать миграции/скрипты `CREATE TABLE`.

---

### 6.2. Базовый бэкенд

- [ ] Поднять проект (например, Spring / Node / другой стек).
- [ ] Подключить БД.
- [ ] Реализовать сущности/модели + репозитории/DAO.

---

### 6.3. Auth / User

- [ ] Регистрация и логин.
- [ ] Хранение `role` у пользователя.
- [ ] Middleware/фильтр для проверки ролей (ограничение доступа к эндпоинтам).

---

### 6.4. Управление вещами (только для `EMPLOYEE`)

- [ ] Эндпоинт создания вещи.
- [ ] Эндпоинт просмотра/редактирования вещи.
- [ ] Логика и эндпоинты изменения статусов вещи.

---

### 6.5. Поиск для пользователей

- [ ] Эндпоинт поиска по названию/категории.
- [ ] Эндпоинт детальной карточки вещи (`GET /items/{id}`).

---

### 6.6. Заявки на возврат

- [ ] Создание заявки пользователем.
- [ ] Просмотр пользователем своих заявок.
- [ ] Панель сотрудника:
  - [ ] список заявок со статусом `PENDING`;
  - [ ] операции `approve/reject`.

---

### 6.7. Выдача (MVP: только самовывоз)

- [ ] Поддержка `fulfillment_type = PICKUP`.
- [ ] Завершение заявки:
  - [ ] `ReturnRequest.status → COMPLETED`;
  - [ ] `LostItem.status → RETURNED`.

---

### 6.8. Доставка (если останется время)

- [ ] Модель `Shipment`.
- [ ] Псевдо-интеграция с «перевозчиком»:
  - [ ] генерация `tracking_number`;
  - [ ] смена статусов `Shipment`.
- [ ] Отслеживание статуса доставки (view для пользователя/сотрудника).

---

